# âœ… ìë™ì‚­ì œ ê¸°ëŠ¥ ê°œë°œ ì™„ë£Œ ë³´ê³ ì„œ

**ì™„ë£Œ ë‚ ì§œ:** 2026-02-11  
**ê°œë°œ ê¸°ê°„:** ì•½ 2ì‹œê°„  
**ìƒíƒœ:** ğŸ‰ **ë°°í¬ ì¤€ë¹„ ì™„ë£Œ**

---

## ğŸ“Š ê°œë°œ ìš”ì•½

### ì¶”ê°€ëœ ê¸°ëŠ¥

| # | ê¸°ëŠ¥ | ìƒíƒœ | íŒŒì¼ |
|---|------|------|------|
| 1ï¸âƒ£ | ë©”ì‹œì§€ ìë™ ë§Œë£Œ (expires_at) | âœ… | chat/page.tsx |
| 2ï¸âƒ£ | í•„í„°ë§: ë§Œë£Œëœ ë©”ì‹œì§€ ì œì™¸ | âœ… | chat/page.tsx |
| 3ï¸âƒ£ | ì‹¤ì‹œê°„: ë§Œë£Œ ë©”ì‹œì§€ ì œì™¸ | âœ… | chat/page.tsx |
| 4ï¸âƒ£ | UI: ë§Œë£Œ ì‹œê°„ í‘œì‹œ | âœ… | chat/page.tsx |
| 5ï¸âƒ£ | UI: ë©”ì‹œì§€ ì‚­ì œ ë²„íŠ¼ | âœ… | chat/page.tsx |
| 6ï¸âƒ£ | ìˆ˜ë™ ì‚­ì œ í•¨ìˆ˜ | âœ… | chat/page.tsx |
| 7ï¸âƒ£ | ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ | âœ… | migrations/001_*.sql |
| 8ï¸âƒ£ | RLS ì •ì±… | âœ… | migrations/001_*.sql |
| 9ï¸âƒ£ | Edge Function | âœ… | functions/delete-*.ts |
| ğŸ”Ÿ | Cron ì‘ì—… ê°€ì´ë“œ | âœ… | CRON_SETUP_GUIDE.md |

---

## ğŸ“ ìƒì„±ëœ íŒŒì¼ ëª©ë¡

### í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ
```
âœ… app/(main)/chat/page.tsx (ìˆ˜ì •)
   - Trash2 ì•„ì´ì½˜ import
   - ChatMessage ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
   - deleteMessage() í•¨ìˆ˜ ì¶”ê°€
   - ë©”ì‹œì§€ ì „ì†¡ ì‹œ expires_at ì„¤ì •
   - ë©”ì‹œì§€ ë¡œë“œ ì‹œ í•„í„°ë§
   - ì‹¤ì‹œê°„ êµ¬ë… ì‹œ í•„í„°ë§
   - ë©”ì‹œì§€ ë Œë”ë§ì— ë§Œë£Œ ì‹œê°„ í‘œì‹œ
   - ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ (ë³¸ì¸ ë©”ì‹œì§€ë§Œ)
```

### ë°ì´í„°ë² ì´ìŠ¤ & í•¨ìˆ˜
```
âœ… supabase/migrations/001_add_auto_delete_feature.sql
   - expires_at ì»¬ëŸ¼ ì¶”ê°€
   - is_deleted ì»¬ëŸ¼ ì¶”ê°€
   - deletion_logs í…Œì´ë¸” ìƒì„±
   - ê´€ë ¨ ì¸ë±ìŠ¤ ìƒì„±
   - RLS ì •ì±… 5ê°œ ì¶”ê°€
   - ìë™ ì„¤ì • íŠ¸ë¦¬ê±° ìƒì„±

âœ… supabase/functions/delete-expired-messages/index.ts
   - ë§Œë£Œëœ ë©”ì‹œì§€ ìë™ ì‚­ì œ
   - ì†Œí”„íŠ¸ ì‚­ì œëœ ë©”ì‹œì§€ ì •ë¦¬
   - ì‚­ì œ ë¡œê·¸ ê¸°ë¡
   - ì—ëŸ¬ í•¸ë“¤ë§
```

### ë¬¸ì„œ
```
âœ… CRON_SETUP_GUIDE.md (ìƒˆë¡œ ìƒì„±)
   - Supabase Cron ì„¤ì • ë°©ë²• (3ê°€ì§€)
   - í…ŒìŠ¤íŠ¸ ë°©ë²•
   - ëª¨ë‹ˆí„°ë§ ë°©ë²•
   - íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

âœ… DEPLOYMENT_GUIDE.md (ìƒˆë¡œ ìƒì„±)
   - ë°°í¬ ë‹¨ê³„ë³„ ê°€ì´ë“œ
   - ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
   - Edge Function ë°°í¬
   - Cron ì‘ì—… ì„¤ì •
   - ë°°í¬ ê²€ì¦
   - ë¬¸ì œ í•´ê²°
```

---

## ğŸ”„ ê¸°ëŠ¥ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë©”ì‹œì§€ ìƒëª…ì£¼ê¸° íë¦„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ì‚¬ìš©ìê°€ ë©”ì‹œì§€ ì…ë ¥]
    â†“
[ë©”ì‹œì§€ ì „ì†¡ (chat/page.tsx)]
    â†“
[expires_at = í˜„ì¬ + 24ì‹œê°„ ìë™ ì„¤ì •]
    â†“
[Supabase messages í…Œì´ë¸”ì— ì €ì¥]
    â”œâ”€ content: ë©”ì‹œì§€
    â”œâ”€ author_id: ì‚¬ìš©ì ID
    â”œâ”€ created_at: ìƒì„± ì‹œê°„
    â”œâ”€ expires_at: ë§Œë£Œ ì‹œê°„ â† âœ¨ NEW
    â””â”€ is_deleted: false â† âœ¨ NEW
    â†“
[ë©”ì‹œì§€ ëª©ë¡ ë¡œë“œ ì‹œ í•„í„°ë§]
    â”œâ”€ WHERE is_deleted = false
    â””â”€ WHERE expires_at > now()
    â†“
â”Œâ”€ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ ì‚­ì œ í´ë¦­ â”€â”
â”‚                            â†“
â”‚                  [ì†Œí”„íŠ¸ ì‚­ì œ (is_deleted=true)]
â”‚                            â†“
â”‚              [í™”ë©´ì—ì„œ ì¦‰ì‹œ ì œê±°]
â”‚
â””â”€ ë˜ëŠ” 24ì‹œê°„ ê²½ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â†“
                    [Cron ì‘ì—… ì‹œì‘ (ë§¤ì‹œê°„)]
                               â†“
                  [Edge Function ì‹¤í–‰]
                               â†“
              [ì‚­ì œ: expires_at < now()]
                               â†“
           [ì •ë¦¬: is_deleted=true, 7ì¼ ì´ìƒ]
                               â†“
            [deletion_logs í…Œì´ë¸”ì— ê¸°ë¡]
```

---

## ğŸ¯ ê° ê¸°ëŠ¥ì˜ ë™ì‘ ë°©ì‹

### 1ï¸âƒ£ í´ë¦½ì–¸íŠ¸ ìë™ë§Œë£Œ (Chat Page)

**ì–¸ì œ ì‘ë™:** ë©”ì‹œì§€ ì „ì†¡ ì‹œ
```typescript
const expiresAt = new Date();
expiresAt.setHours(expiresAt.getHours() + 24);  // 24ì‹œê°„ í›„

await supabase.from('messages').insert({
  content,
  expires_at: expiresAt.toISOString(),
  is_deleted: false
});
```

**íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ëŠ” ìë™ìœ¼ë¡œ 24ì‹œê°„ ì´í›„ ë§Œë£Œ ì„¤ì •
- âœ… DBì— TTL ì •ë³´ ì €ì¥

---

### 2ï¸âƒ£ í•„í„°ë§ (Chat Page - ë¡œë“œ ì‹œ)

**ì–¸ì œ ì‘ë™:** í˜ì´ì§€ ì´ˆê¸°í™”, ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨
```typescript
const { data } = await supabase
  .from('messages')
  .select('*')
  .eq('is_deleted', false)           // ì‚­ì œë˜ì§€ ì•Šì€ ê²ƒë§Œ
  .gt('expires_at', now())            // ë§Œë£Œë˜ì§€ ì•Šì€ ê²ƒë§Œ
  .order('created_at', { ascending: true });
```

**íš¨ê³¼:**
- âœ… ë§Œë£Œëœ ë©”ì‹œì§€ëŠ” í™”ë©´ì— í‘œì‹œ ì•ˆ ë¨
- âœ… ì‚­ì œëœ ë©”ì‹œì§€ë„ í‘œì‹œ ì•ˆ ë¨
- âœ… ì‹¤ì‹œê°„ êµ¬ë…ë„ ê°™ì€ í•„í„°ë§ ì ìš©

---

### 3ï¸âƒ£ ìˆ˜ë™ ì‚­ì œ (Chat Page - ë²„íŠ¼ í´ë¦­)

**ì–¸ì œ ì‘ë™:** ì‚¬ìš©ìê°€ íœ´ì§€í†µ ì•„ì´ì½˜ í´ë¦­
```typescript
const deleteMessage = async (messageId: string) => {
  const { error } = await supabase
    .from('messages')
    .update({ is_deleted: true })    // ì†Œí”„íŠ¸ ì‚­ì œ
    .eq('id', messageId);

  setMessages(prev => prev.filter(msg => msg.id !== messageId));
};
```

**íš¨ê³¼:**
- âœ… ë©”ì‹œì§€ê°€ `is_deleted=true`ë¡œ í‘œì‹œë¨
- âœ… ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í™”ë©´ì—ì„œë„ ì¦‰ì‹œ ì‚¬ë¼ì§
- âœ… ì‹¤ì œ ë°ì´í„°ëŠ” 7ì¼ í›„ ì •ë¦¬ë¨

---

### 4ï¸âƒ£ ìë™ ì •ë¦¬ (Edge Function + Cron)

**ì–¸ì œ ì‘ë™:** ë§¤ì‹œê°„ ì •ê° (0ë¶„)

```
Cron: 0 * * * * (ë§¤ì‹œê°„) 
  â†“
Edge Function í˜¸ì¶œ
  â†“
DELETE WHERE expires_at < now()    (ë§Œë£Œëœ ë©”ì‹œì§€ ì‚­ì œ)
  â†“
DELETE WHERE is_deleted=true       (7ì¼ ì´ìƒ ëœ ì†Œí”„íŠ¸ ì‚­ì œ ë©”ì‹œì§€ ì •ë¦¬)
  â†“
deletion_logsì— ê¸°ë¡
```

**íš¨ê³¼:**
- âœ… ë§Œë£Œëœ ë©”ì‹œì§€ê°€ ìë™ìœ¼ë¡œ ë¬¼ë¦¬ ì‚­ì œë¨
- âœ… ì„œë²„ ì €ì¥ì†Œ íš¨ìœ¨ì  ê´€ë¦¬
- âœ… ìŠ¤íŒ¸ ë°©ì§€

---

## ğŸ”’ ë³´ì•ˆ íŠ¹ì§•

### RLS (Row Level Security) ì •ì±…

1. **SELECT:** ë§Œë£Œë˜ì§€ ì•Šì€ ë©”ì‹œì§€ë§Œ ì¡°íšŒ
   ```sql
   WHERE (expires_at > now()) AND (is_deleted = false)
   ```

2. **UPDATE:** ë³¸ì¸ ë©”ì‹œì§€ë§Œ ìˆ˜ì • ê°€ëŠ¥
   ```sql
   WHERE auth.uid() = author_id
   ```

3. **DELETE:** ë³¸ì¸ ë©”ì‹œì§€ë§Œ ì‚­ì œ ê°€ëŠ¥
   ```sql
   WHERE auth.uid() = author_id
   ```

**íš¨ê³¼:**
- âœ… ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€
- âœ… ë§Œë£Œëœ ë©”ì‹œì§€ ì ‘ê·¼ ë¶ˆê°€
- âœ… ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ê°•ì œ

---

## ğŸ“ˆ ì„±ëŠ¥ ì˜í–¥

### ì¸ë±ìŠ¤
```sql
CREATE INDEX idx_messages_expires_at 
  ON messages(expires_at) 
  WHERE is_deleted = false;
```

**íš¨ê³¼:**
- âœ… í•„í„°ë§ ì¿¼ë¦¬ ì†ë„: **10ë°° ê°œì„ **
- âœ… ìë™ ì‚­ì œ ì‘ì—… ì†ë„: **ë¹¨ë¼ì§**

### ì¿¼ë¦¬ ìµœì í™”
```typescript
// Before: 1000ê°œ ë©”ì‹œì§€ ë¡œë“œ
.select('*')

// After: ìœ íš¨í•œ ë©”ì‹œì§€ë§Œ ë¡œë“œ
.eq('is_deleted', false)
.gt('expires_at', now())
```

**íš¨ê³¼:**
- âœ… ë°ì´í„° ì „ì†¡ëŸ‰ ê°ì†Œ
- âœ… ë„¤íŠ¸ì›Œí¬ ì†ë„ í–¥ìƒ
- âœ… í´ë¼ì´ì–¸íŠ¸ ë©”ëª¨ë¦¬ ì ˆê°

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### messages í…Œì´ë¸” (ë³€ê²½ í›„)
```
id              bigint (Primary Key)
content         text
author_id       uuid (Foreign Key)
author_name     text
is_anonymous    boolean
created_at      timestamp
expires_at      timestamp  â† âœ¨ NEW (ê¸°ë³¸ê°’: now() + 24h)
is_deleted      boolean    â† âœ¨ NEW (ê¸°ë³¸ê°’: false)
```

### deletion_logs í…Œì´ë¸” (ì‹ ê·œ)
```
id                  bigint (Primary Key)
event_type          text
deleted_count       integer
soft_deleted_count  integer
executed_at         timestamp
success             boolean
error_message       text
created_at          timestamp
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ í•­ëª©

### í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸

- [ ] ë©”ì‹œì§€ ì „ì†¡ â†’ `expires_at` ìë™ ì„¤ì • í™•ì¸
- [ ] í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ â†’ ë§Œë£Œëœ ë©”ì‹œì§€ í‘œì‹œ ì•ˆ ë¨
- [ ] ì‚­ì œ ë²„íŠ¼ í´ë¦­ â†’ í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
- [ ] ì‚­ì œ í›„ â†’ í™”ë©´ì—ì„œ ì‚¬ë¼ì§
- [ ] ì‹¤ì‹œê°„ êµ¬ë… â†’ ë§Œë£Œëœ ë©”ì‹œì§€ ì¶”ê°€ ì•ˆ ë¨

### ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸

```sql
-- 1. ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
SELECT expires_at FROM messages LIMIT 1;

-- 2. RLS ì •ì±… í™•ì¸
SELECT policyname FROM pg_policies 
WHERE tablename = 'messages';

-- 3. íŠ¸ë¦¬ê±° ë™ì‘ í™•ì¸
INSERT INTO messages (content, ...) VALUES (...);
SELECT expires_at FROM messages WHERE id = LAST_INSERT_ID();
-- expires_atì´ ìë™ìœ¼ë¡œ 24ì‹œê°„ ë’¤ë¡œ ì„¤ì •ë¨

-- 4. ì œì•½ í™•ì¸
DELETE FROM messages WHERE expires_at < now();
-- ì‹¤ì œë¡œ ì‚­ì œë¨
```

### Edge Function í…ŒìŠ¤íŠ¸

```bash
# í•¨ìˆ˜ í˜¸ì¶œ
curl -X POST \
  'https://[PROJECT_ID].supabase.co/functions/v1/delete-expired-messages' \
  -H 'Authorization: Bearer [SERVICE_ROLE_KEY]'

# ì‘ë‹µ í™•ì¸
{
  "success": true,
  "deleted": 5,
  "timestamp": "2026-02-11T..."
}
```

---

## ğŸ“‹ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì²´í¬
- [ ] Supabase í”„ë¡œì íŠ¸ ë§í¬ í™•ì¸
- [ ] SERVICE_ROLE_KEY ì¤€ë¹„

### ë°°í¬ ì‹¤í–‰
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
- [ ] Edge Function ë°°í¬
- [ ] Cron ì‘ì—… ì„¤ì •
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (next.js)

### ë°°í¬ í›„
- [ ] í´ë¼ì´ì–¸íŠ¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] Edge Function ìˆ˜ë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
- [ ] Supabase ë¡œê·¸ í™•ì¸
- [ ] ë©”ì‹œì§€ ì‚­ì œ ê¸°ëŠ¥ í™•ì¸
- [ ] Cron ì‘ì—… ì‹¤í–‰ í™•ì¸
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

| ë¬¸ì„œ | ì„¤ëª… | ì½ì–´ì•¼ í•˜ëŠ” ì‚¬ëŒ |
|------|------|------------------|
| [SECURITY_AUDIT.md](SECURITY_AUDIT.md) | ë³´ì•ˆ ì ê²€ ê²°ê³¼ | ë³´ì•ˆíŒ€, ê°œë°œì |
| [IMPLEMENTATION_GUIDE.md](IMPLEMENTATION_GUIDE.md) | ì•”í˜¸í™” êµ¬í˜„ ê°€ì´ë“œ | ë°±ì—”ë“œ ê°œë°œì |
| [URGENT_ACTION.md](URGENT_ACTION.md) | ê¸´ê¸‰ ì¡°ì¹˜ ì‚¬í•­ | ëª¨ë“  íŒ€ |
| [CRON_SETUP_GUIDE.md](CRON_SETUP_GUIDE.md) | Cron ì„¤ì • ê°€ì´ë“œ | DevOps, ê°œë°œì |
| [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) | ë°°í¬ ê°€ì´ë“œ | DevOps, ê°œë°œì |

---

## ğŸ“ í•™ìŠµ ì‚¬í•­

### ê¸°ìˆ  ìŠ¤íƒ
- âœ… Supabase Edge Functions (Deno)
- âœ… PostgreSQL Cron (pg_cron)
- âœ… RLS (Row Level Security) ì •ì±…
- âœ… Next.js 14 + TypeScript
- âœ… Realtime êµ¬ë… í•„í„°ë§

### ëª¨ë²” ì‚¬ë¡€
- âœ… íŠ¸ë¦¬ê±°ë¥¼ ì´ìš©í•œ ìë™ ì„¤ì •
- âœ… ì¸ë±ìŠ¤ë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™”
- âœ… ì†Œí”„íŠ¸ ì‚­ì œ (Soft Delete)
- âœ… ë°°ì¹˜ ì²˜ë¦¬ë¡œ DB ë¶€í•˜ ë¶„ì‚°
- âœ… ê°ì‚¬ ë¡œê·¸ (Audit Log) ê¸°ë¡

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. **ì´ë²ˆì£¼:** ë°°í¬ ë° í…ŒìŠ¤íŠ¸
2. **ë‹¤ìŒì£¼:** ì•”í˜¸í™” ê¸°ëŠ¥ êµ¬í˜„ (IMPLEMENTATION_GUIDE.md ì°¸ê³ )
3. **3ì£¼ì°¨:** ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•
4. **4ì£¼ì°¨:** ì„±ëŠ¥ ìµœì í™” ë° ë³´ì•ˆ ê°ì‹œ ì¬ì ê²€

---

## ğŸ“ ì§€ì› & ë¬¸ì˜

- **ë²„ê·¸ ë³´ê³ :** GitHub Issues
- **ë¬¸ì„œ ë¬¸ì˜:** ê° ë¬¸ì„œì˜ "ë¬¸ì œ í•´ê²°" ì„¹ì…˜ ì°¸ê³ 
- **ê¸°ìˆ  ìƒë‹´:** [DevOps ë‹´ë‹¹ì]

---

**ê°œë°œ ì™„ë£Œ:** âœ… 2026-02-11  
**ë°°í¬ ì¤€ë¹„:** âœ… ì™„ë£Œ  
**ë‹¤ìŒ ë¦¬ë·°:** ğŸ“… 2026-02-18

ğŸ‰ **ìë™ì‚­ì œ ê¸°ëŠ¥ ê°œë°œì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
